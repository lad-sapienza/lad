name: Build and Deploy to Production

on:
  # Trigger on push to master branch
  push:
    branches: [ master ]
    
  # Allow manual deployment from Actions tab
  workflow_dispatch:
  
  # Allow webhook triggers (e.g., from WordPress)
  repository_dispatch:
    types: [ publish_blog ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout the repository
      - name: Check out repository
        uses: actions/checkout@v4

      # Setup Node.js (match your local development version)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      # Cache Gatsby build artifacts
      - name: Cache Gatsby build
        uses: actions/cache@v4
        with:
          path: |
            .cache
            public
          key: ${{ runner.os }}-gatsby-${{ hashFiles('package-lock.json') }}-${{ hashFiles('gatsby-config.js') }}
          restore-keys: |
            ${{ runner.os }}-gatsby-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-gatsby-

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Build Gatsby site with path prefix
      - name: Build Gatsby site
        run: npm run build
        env:
          # Add any environment variables needed for build
          NODE_ENV: production
          # Limit Sharp concurrency to avoid memory issues
          GATSBY_CPU_COUNT: 2
          # If you need specific build flags, add them here

      # Install SNX VPN client
      - name: Install SNX dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            libpam0g \
            iptables \
            net-tools \
            iputils-ping \
            netcat-openbsd \
            rsync \
            expect \
            libc6:i386 \
            libstdc++6:i386 || true
          
          # Try to install 32-bit packages if available
          sudo apt-get install -y \
            libstdc++5:i386 \
            libpam0g:i386 \
            libx11-6:i386 \
            libxau6:i386 \
            libxcb1:i386 \
            libxdmcp6:i386 \
            libxext6:i386 2>/dev/null || echo "Some i386 libraries not available, continuing..."
          
      # Download and setup SNX
      - name: Setup SNX VPN client
        run: |
          echo "Downloading SNX from: ${{ secrets.SNX_DOWNLOAD_URL }}"
          wget ${{ secrets.SNX_DOWNLOAD_URL }} -O /tmp/snx_install.sh
          
          # Make executable and install
          chmod +x /tmp/snx_install.sh
          sudo /tmp/snx_install.sh
          
          # Verify installation
          if which snx; then
            echo "✅ SNX installed successfully"
            snx -v || echo "SNX version command not available"
          else
            echo "❌ SNX installation failed"
            exit 1
          fi
          
      # Connect to VPN
      - name: Connect to SNX VPN
        run: |
          echo "Testing VPN connection..."
          echo "VPN Gateway: ${{ secrets.VPN_GATEWAY }}"
          echo "VPN Username: ${{ secrets.VPN_USERNAME }}"
          
          # Create expect script to handle interactive prompts
          cat > /tmp/snx_connect.exp <<'EOFEXP'
          #!/usr/bin/expect -f
          set timeout 60
          set gateway [lindex $argv 0]
          set username [lindex $argv 1]
          set password [lindex $argv 2]
          
          spawn snx -u $username -s $gateway
          
          expect {
            "Please enter your password:" {
              send "$password\r"
              exp_continue
            }
            "Do you accept*" {
              send "y\r"
              exp_continue
            }
            "SNX - connected" {
              puts "VPN connected successfully"
            }
            timeout {
              puts "Timeout waiting for VPN connection"
              exit 1
            }
            eof {
              puts "SNX process ended"
            }
          }
          
          # Keep script running so SNX stays connected
          sleep 600
          EOFEXP
          
          chmod +x /tmp/snx_connect.exp
          
          # Connect to VPN
          echo "Connecting to VPN gateway: ${{ secrets.VPN_GATEWAY }}"
          echo "Running SNX connection script..."
          
          # Run in background but with explicit output handling
          sudo /tmp/snx_connect.exp \
               "${{ secrets.VPN_GATEWAY }}" \
               "${{ secrets.VPN_USERNAME }}" \
               "${{ secrets.VPN_PASSWORD }}" > /tmp/snx.log 2>&1 &
          
          # Store the background process PID
          SNX_PID=$!
          echo "SNX expect script PID: $SNX_PID"
          
          # Wait for connection to establish with progress indicator
          echo "Waiting for VPN connection to establish..."
          for i in {1..60}; do
            sleep 1
            
            # Show log content as it grows (last few lines)
            if [ -f /tmp/snx.log ]; then
              if [ $((i % 10)) -eq 0 ]; then
                echo "--- Log content at ${i} seconds ---"
                tail -5 /tmp/snx.log
                echo "---"
              fi
            fi
            
            if grep -q "SNX - connected" /tmp/snx.log 2>/dev/null; then
              echo "✅ VPN connected (after ${i} seconds)"
              break
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still waiting... (${i}/60 seconds)"
            fi
          done
          
          # Show complete SNX log
          echo "=== COMPLETE SNX Connection Log ==="
          if [ -f /tmp/snx.log ]; then
            cat /tmp/snx.log
          else
            echo "❌ No log file found at /tmp/snx.log"
          fi
          echo "==================================="
          
          # Verify SNX is running
          if ps aux | grep -v grep | grep -q "snx"; then
            echo "✅ SNX process is running"
          else
            echo "❌ SNX process not found"
            exit 1
          fi
          
          # Verify VPN connection
          echo "Checking VPN interface..."
          
          # Wait up to 30 seconds for tunnel interface to appear
          TUNNEL_FOUND=0
          for i in {1..30}; do
            if ifconfig tunsnx 2>/dev/null || ip addr show tunsnx 2>/dev/null; then
              echo "✅ VPN interface tunsnx is UP"
              TUNNEL_FOUND=1
              break
            fi
            if [ $((i % 5)) -eq 0 ]; then
              echo "Waiting for tunnel interface... (${i}/30)"
            fi
            sleep 1
          done
          
          if [ $TUNNEL_FOUND -eq 0 ]; then
            echo "❌ VPN tunnel interface not created after 30 seconds"
            echo "Available interfaces:"
            ifconfig -a || ip addr show
            echo ""
            echo "SNX may be running but tunnel is not established."
            echo "Check the SNX log above for errors."
            exit 1
          fi
          
          # Show routing table
          echo "=== Routing table ==="
          ip route
          echo "====================="
          
          # Test connectivity to production server (internal address)
          echo "Testing connectivity to production server..."
          if ping -c 3 -W 2 ${{ secrets.SSH_HOST }}; then
            echo "✅ Ping successful"
          else
            echo "⚠️ Warning: Cannot ping server (may be blocked by firewall)"
          fi
          
          # Test SSH port connectivity
          echo "Testing SSH port 22..."
          if timeout 10 nc -zv ${{ secrets.SSH_HOST }} 22; then
            echo "✅ SSH port 22 is reachable"
          else
            echo "❌ SSH port 22 is not reachable"
            echo "VPN may not be working properly. Check SNX log above."
            exit 1
          fi
        timeout-minutes: 5
        continue-on-error: false

      # Setup SSH for deployment
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Configure SSH
          cat >> ~/.ssh/config <<END
          Host lad-production
            HostName ${{ secrets.SSH_HOST }}
            User ${{ secrets.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            HostKeyAlgorithms +ssh-rsa
            PubkeyAcceptedKeyTypes +ssh-rsa
          END
          
          # Add host to known_hosts
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # Deploy to production server
      - name: Deploy to production
        run: |
          rsync -arvzu --delete \
            --filter='P .ssh' \
            --filter='P .bash_history' \
            --filter='P .screenrc' \
            -e 'ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no' \
            public/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:

      # Disconnect VPN
      - name: Disconnect SNX VPN
        if: always()
        run: |
          sudo snx -d || echo "VPN already disconnected"

      # Optional: Notify on success
      - name: Deployment successful
        if: success()
        run: |
          echo "✅ Deployment completed successfully"
          echo "Deployed to: ${{ secrets.SSH_HOST }}"
