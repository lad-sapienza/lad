name: Test SNX VPN Connection

# Manual trigger only - for testing VPN setup
on:
  workflow_dispatch:

jobs:
  test-vpn:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install SNX dependencies
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            libpam0g \
            iptables \
            net-tools \
            iputils-ping \
            netcat-openbsd \
            libc6:i386 \
            libstdc++6:i386 || true
          
          # Try to install 32-bit packages if available
          sudo apt-get install -y \
            libstdc++5:i386 \
            libpam0g:i386 \
            libx11-6:i386 \
            libxau6:i386 \
            libxcb1:i386 \
            libxdmcp6:i386 \
            libxext6:i386 2>/dev/null || echo "Some i386 libraries not available, continuing..."
          
      - name: Download and install SNX
        run: |
          echo "Downloading SNX from: ${{ secrets.SNX_DOWNLOAD_URL }}"
          wget ${{ secrets.SNX_DOWNLOAD_URL }} -O /tmp/snx_install.sh
          chmod +x /tmp/snx_install.sh
          sudo /tmp/snx_install.sh
          
          # Verify installation
          if which snx; then
            echo "✅ SNX installed successfully"
            snx -v || echo "SNX version command not available"
          else
            echo "❌ SNX installation failed"
            exit 1
          fi
          
      - name: Test VPN connection
        run: |
          echo "Testing VPN connection..."
          echo "VPN Gateway: ${{ secrets.VPN_GATEWAY }}"
          echo "VPN Username: ${{ secrets.VPN_USERNAME }}"
          
          # Install expect
          sudo apt-get install -y expect
          
          # Create expect script to handle interactive prompts
          cat > /tmp/snx_connect.exp <<'EOFEXP'
          #!/usr/bin/expect -f
          set timeout 60
          set gateway [lindex $argv 0]
          set username [lindex $argv 1]
          set password [lindex $argv 2]
          
          spawn snx -u $username -s $gateway
          
          expect {
            "Please enter your password:" {
              send "$password\r"
              exp_continue
            }
            "Do you accept*" {
              send "y\r"
              exp_continue
            }
            "SNX - connected" {
              puts "VPN connected successfully"
            }
            timeout {
              puts "Timeout waiting for VPN connection"
              exit 1
            }
            eof {
              puts "SNX process ended"
            }
          }
          
          # Keep script running so SNX stays connected
          sleep 300
          EOFEXP
          
          chmod +x /tmp/snx_connect.exp
          
          # Connect to VPN
          echo "Connecting to VPN..."
          echo "Running SNX connection script..."
          
          # Run in background but with explicit output handling
          sudo /tmp/snx_connect.exp \
               "${{ secrets.VPN_GATEWAY }}" \
               "${{ secrets.VPN_USERNAME }}" \
               "${{ secrets.VPN_PASSWORD }}" > /tmp/snx.log 2>&1 &
          
          # Store the background process PID
          SNX_PID=$!
          echo "SNX expect script PID: $SNX_PID"
          
          # Wait for connection to establish with progress indicator
          echo "Waiting for VPN connection to establish..."
          for i in {1..60}; do
            sleep 1
            
            # Show log content as it grows (last few lines)
            if [ -f /tmp/snx.log ]; then
              if [ $((i % 10)) -eq 0 ]; then
                echo "--- Log content at ${i} seconds ---"
                tail -5 /tmp/snx.log
                echo "---"
              fi
            fi
            
            if grep -q "SNX - connected" /tmp/snx.log 2>/dev/null; then
              echo "✅ VPN connected (after ${i} seconds)"
              break
            fi
            if [ $((i % 10)) -eq 0 ]; then
              echo "Still waiting... (${i}/60 seconds)"
            fi
          done
          
          # Show complete SNX log
          echo "=== COMPLETE SNX Connection Log ==="
          if [ -f /tmp/snx.log ]; then
            cat /tmp/snx.log
          else
            echo "❌ No log file found at /tmp/snx.log"
          fi
          echo "==================================="
          
          # Check if SNX is running
          echo "Checking SNX process..."
          ps aux | grep snx
          
          if ps aux | grep -v grep | grep -q "snx"; then
            echo "✅ SNX process is running"
          else
            echo "❌ SNX process not found"
            exit 1
          fi
          
          # Check VPN interface
          echo "Checking VPN interface..."
          
          # Wait up to 30 seconds for tunnel interface to appear
          TUNNEL_FOUND=0
          for i in {1..30}; do
            if ifconfig tunsnx 2>/dev/null || ip addr show tunsnx 2>/dev/null; then
              echo "✅ VPN interface tunsnx is UP"
              TUNNEL_FOUND=1
              break
            fi
            if [ $((i % 5)) -eq 0 ]; then
              echo "Waiting for tunnel interface... (${i}/30)"
            fi
            sleep 1
          done
          
          if [ $TUNNEL_FOUND -eq 0 ]; then
            echo "❌ VPN tunnel interface not created after 30 seconds"
            echo "=== Available interfaces ==="
            ifconfig -a || ip addr show
            echo "============================"
            echo ""
            echo "SNX may be running but tunnel is not established."
            echo "Check the SNX log above for errors."
            exit 1
          fi
          
          # Show routing table
          echo "=== Routing table ==="
          ip route
          echo "====================="
          
      - name: Test connectivity to production server
        run: |
          echo "Testing connectivity to: ${{ secrets.SSH_HOST }}"
          
          # Check if we're still connected to VPN
          if ! ps aux | grep -v grep | grep -q "snx"; then
            echo "❌ SNX process is no longer running!"
            echo "VPN connection may have dropped."
            exit 1
          fi
          
          # Try DNS resolution
          echo "Testing DNS resolution..."
          if nslookup ${{ secrets.SSH_HOST }}; then
            echo "✅ DNS resolution successful"
          else
            echo "⚠️ DNS resolution failed, trying with different DNS"
            nslookup ${{ secrets.SSH_HOST }} 8.8.8.8 || echo "Failed with Google DNS too"
          fi
          
          # Try ping
          echo "Testing ping..."
          if ping -c 3 -W 2 ${{ secrets.SSH_HOST }}; then
            echo "✅ Ping successful"
          else
            echo "⚠️ Ping failed (may be blocked by firewall or VPN not connected)"
          fi
          
          # Try SSH port
          echo "Testing SSH port 22..."
          if timeout 10 nc -zv ${{ secrets.SSH_HOST }} 22; then
            echo "✅ SSH port 22 is reachable"
          else
            echo "❌ SSH port 22 is not reachable"
            echo "This suggests the VPN connection is not working properly."
            echo "Check the SNX log above for connection errors."
            exit 1
          fi
          
      - name: Test SSH connection
        run: |
          echo "Setting up SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/test_key
          chmod 600 ~/.ssh/test_key
          
          echo "Testing SSH connection..."
          if ssh -i ~/.ssh/test_key \
                 -o StrictHostKeyChecking=no \
                 -o ConnectTimeout=10 \
                 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
                 'echo "SSH connection successful" && hostname && uptime'; then
            echo "✅ SSH connection successful"
          else
            echo "❌ SSH connection failed"
            exit 1
          fi
          
      - name: Disconnect VPN
        if: always()
        run: |
          echo "Disconnecting VPN..."
          sudo snx -d || echo "VPN already disconnected"
          
      - name: Test Summary
        if: success()
        run: |
          echo "============================================"
          echo "✅ ALL TESTS PASSED!"
          echo "============================================"
          echo ""
          echo "Your VPN and SSH setup is working correctly."
          echo "You can now use the full deployment workflow."
          echo ""
          echo "Next steps:"
          echo "1. Push to master branch to trigger automatic deployment"
          echo "2. Or manually trigger 'Build and Deploy to Production' workflow"
